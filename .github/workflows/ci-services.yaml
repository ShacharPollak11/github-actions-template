run-name: CI service ${{ inputs.service_type }}

on:
  workflow_call:
    inputs:
      aws_ci_region:
        type: string
        default: "us-east-1"
      aws_ci_account:
        type: string
        default: "479886561928"
      projects_args:
        default: "[]"
        required: true
        type: string
      enable-test:
        required: false
        type: boolean
        default: true
      enable-resharper:
        required: false
        type: boolean
        default: false
      enable_api_tests:
        required: false
        type: boolean
        default: false
      enable-ecr:
        required: false
        type: boolean
        default: true
      enable-sonarqube:
        required: false
        type: boolean
        default: true
      service_type:
        required: true
        type: string
      test-file-path:
        required: false
        type: string
      localstack-docker-compose:
          required: false
          type: string
          default: ""

    outputs:
      services:
        description: "The services to build"
        value: ${{ jobs.read-json.outputs.services }}
      run_id:
        value: ${{ jobs.ci-service-csharp.outputs.run_id }}

jobs:
  read-json:
    # runs-on: self-hosted
    runs-on: ubuntu-latest
    permissions:
      id-token: write # This is required for requesting the JWT
      contents: read # This is required for actions/checkout
    steps:
      - uses: actions/checkout@v3
      - id: services
        run: |
          if [[ "${{ inputs.projects_args }}" == *.json ]]; then
            content=$(cat ${{inputs.projects_args}})
          else
            content="${{ inputs.projects_args }}"
          fi
          echo "services<<EOF" >> $GITHUB_OUTPUT
          echo "$content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo $content
    outputs:
      services: ${{ steps.services.outputs.services }}

  ci-service-csharp:
    if: ${{ inputs.service_type == 'csharp' }}
    needs: read-json
    permissions:
      id-token: write # This is required for requesting the JWT
      contents: read # This is required for actions/checkout
    strategy:
      fail-fast: false
      matrix:
        array: ${{ fromJson(needs.read-json.outputs.services) }}
    uses: ./.github/workflows/ci-service-csharp.yaml
    secrets: inherit
    name: CI for ${{ matrix.array.service_name }}
    with:
      context_path: ${{ matrix.array.context_path }}
      solution_file: ${{ matrix.array.solution_file }}
      dockerfile_path: ${{ matrix.array.dockerfile_path }}
      service_name: ${{ matrix.array.service_name }}
      enable_api_tests: ${{ matrix.array.enable_api_tests }}
      enable-test: ${{ inputs.enable-test }}
      enable-ecr: ${{ inputs.enable-ecr }}
      enable-resharper: ${{ inputs.enable-resharper }}
      enable-sonarqube: ${{ inputs.enable-sonarqube }}

  ci-service-python:
    if: ${{ inputs.service_type == 'python' && needs.read-json.outputs.services != '[]'}}
    needs: read-json
    permissions:
      id-token: write # This is required for requesting the JWT
      contents: read # This is required for actions/checkout
    strategy:
      fail-fast: false
      matrix:
        array: ${{ fromJson(needs.read-json.outputs.services) }}
    uses: ./.github/workflows/ci-service-python.yaml
    secrets: inherit
    name: CI for ${{ matrix.array.service_name }}
    with:
      context_path: ${{ matrix.array.context_path }}
      dockerfile_path: ${{ matrix.array.dockerfile_path }}
      service_name: ${{ matrix.array.service_name }}
      enable-ecr: ${{ inputs.enable-ecr }}
      enable-sonarqube: ${{ inputs.enable-sonarqube }}
      test-file-path: ${{ inputs.test-file-path }}
      enable-test: ${{ inputs.enable-test }}
      localstack-docker-compose: ${{ inputs.localstack-docker-compose }}

  ci-service-default:
    if: ${{ inputs.service_type != 'csharp' && inputs.service_type != 'python' }}
    runs-on: ubuntu-latest
    steps:
      - name: Fail Pipeline
        run: |
          echo "Invalid service_type provided: ${{ inputs.service_type }} only 'cshapr' or 'python'"; exit 1
